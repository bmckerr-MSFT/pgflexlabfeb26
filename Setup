# Install extensions

CREATE EXTENSION IF NOT EXISTS azure_ai;
CREATE EXTENSION IF NOT EXISTS vector;

SHOW azure.extensions;

# Setup integration with Azure OpenAI
SELECT azure_ai.set_setting('azure_openai.endpoint', 'https://flexlabfeb26.openai.azure.com/');
SELECT azure_ai.set_setting('azure_openai.auth_type', 'managed-identity');

SELECT azure_ai.get_setting('azure_openai.endpoint');
SELECT azure_ai.get_setting('azure_openai.auth_type');

# Test embedding function
SELECT azure_openai.create_embeddings('text-embedding-ada-002', 'Your text here');



Ref : https://github.com/jjfrost/pg-af-agents-lab/blob/main/Docs/lab_manual.md

==============================

set search_path TO schema$$$$, public;
show search_path;

-- Description: This script creates the tables and loads the data into the tables.
-- It creates a table to store the cases data and loads the data from the cases.csv file into the table.

DROP TABLE IF EXISTS cases;
DROP TABLE IF EXISTS temp_cases;

-- Create a table to store the cases data
CREATE TABLE cases(
        id SERIAL PRIMARY KEY,
        name TEXT,
        decision_date DATE,
        court_id INT,
        opinion TEXT
    );

-- Create a temp table to store the cases data 
CREATE TABLE temp_cases(data jsonb);

- used pgadmin for this with PSQL
\COPY temp_cases (data) FROM 'c:/users/brianmckerr/downloads/cases.csv' WITH (FORMAT csv, HEADER true


-- Insert data into the cases table
INSERT INTO cases
SELECT
        (data#>>'{id}')::int AS id, 
        (data#>>'{name_abbreviation}')::text AS name, 
        (data#>>'{decision_date}')::date AS decision_date, 
        (data#>>'{court,id}')::int AS court_id, 
        array_to_string(ARRAY(SELECT jsonb_path_query(data, '$.casebody.opinions[*].text')), ', ') AS opinion
FROM temp_cases;


grant select on public.cases to public;


Cleanup
=======

DO $$
DECLARE
  i int;
BEGIN
  FOR i IN 1..20 LOOP
    EXECUTE format('DROP TABLE IF EXISTS %I.%I CASCADE', 'schema'||i, 'cases');
  END LOOP;
END $$;

