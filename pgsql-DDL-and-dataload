Ref : https://github.com/jjfrost/pg-af-agents-lab/blob/main/Docs/lab_manual.md

==============================

set search_path TO schema$$$$, public;
show search_path;

-- Description: This script creates the tables and loads the data into the tables.
-- It creates a table to store the cases data and loads the data from the cases.csv file into the table.

DROP TABLE IF EXISTS cases;
DROP TABLE IF EXISTS temp_cases;

-- Create a table to store the cases data
CREATE TABLE cases(
        id SERIAL PRIMARY KEY,
        name TEXT,
        decision_date DATE,
        court_id INT,
        opinion TEXT
    );

-- Create a temp table to store the cases data 
CREATE TABLE temp_cases(data jsonb);

- used pgadmin for this with PSQL
\COPY temp_cases (data) FROM 'c:/users/brianmckerr/downloads/cases.csv' WITH (FORMAT csv, HEADER true


-- Insert data into the cases table
INSERT INTO cases
SELECT
        (data#>>'{id}')::int AS id, 
        (data#>>'{name_abbreviation}')::text AS name, 
        (data#>>'{decision_date}')::date AS decision_date, 
        (data#>>'{court,id}')::int AS court_id, 
        array_to_string(ARRAY(SELECT jsonb_path_query(data, '$.casebody.opinions[*].text')), ', ') AS opinion
FROM temp_cases;


=========

insert into cases select * from public.cases;



SELECT id, name, opinion
FROM cases
WHERE opinion ILIKE '%Water leaking into the apartment from the floor above%';

ALTER TABLE cases ADD COLUMN IF NOT EXISTS opinions_vector vector(1536);

UPDATE cases
SET opinions_vector = azure_openai.create_embeddings(
    'text-embedding-3-small',
    name || LEFT(opinion, 8000),
    max_attempts => 5,
    retry_delay_ms => 500
)::vector
WHERE opinions_vector IS NULL;

CREATE EXTENSION IF NOT EXISTS pg_diskann;
CREATE INDEX IF NOT EXISTS cases_cosine_diskann
ON cases USING diskann(opinions_vector vector_cosine_ops);


SELECT opinions_vector FROM cases LIMIT 1;


SELECT id, name
FROM cases
ORDER BY opinions_vector <=> azure_openai.create_embeddings(
    'text-embedding-3-small',
    'Water leaking into the apartment from the floor above.'
)::vector
LIMIT 10;

SELECT id, opinion
FROM cases
ORDER BY opinions_vector <=> azure_openai.create_embeddings(
    'text-embedding-3-small',
    'Water leaking into the apartment from the floor above.'
)::vector
LIMIT 1;


https://github.com/jjfrost/pg-af-agents-lab/tree/main



